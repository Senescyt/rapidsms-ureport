{% extends "ureport_layout.html" %}
{% block page_title %} National Pulse {% endblock %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}ureport/stylesheets/dc.css"/>
    <style>
      .control {
        position: fixed;
        float: none;
        right: 10px;
      }
      .donut {
        right: -20px;
      }
      #risks-pie-chart {
        top: 200px;
      }
      .legend {
        width: 4em;
        list-style-type: none;
        float: left;
        padding: 0px;
      }
      .legend > li {
        color: #CCC;
        text-align: center;
      }
    </style>
{% endblock %}

{% block top_js %}
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/d3.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/crossfilter.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/queue.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/dc.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/colorbrewer.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}ureport/javascripts/underscore-min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div id="ug-chart">
        <h3>Colors Range From Yellow - Green - Blue. that reflects the percentage of most dominant category over<br/> the  contribution From Low - High </h3>
        <a class="reset" href="javascript:ugChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>

        <div class="clearfix"></div>
    </div>

    <div id="totals-chart">
        <strong>By Percent Dominant Category: (Y-Axis: number of responses, X-Axis: percent dominant out of total,<br/> Radius: number of dominant responses)</strong>
        <a class="reset" href="javascript:totalsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

        <div class="clearfix"></div>
    </div>

    <div class="clearfix"></div>

    <div id="national-pie-chart" class="donut control">
        <a class="reset" href="javascript:nationalPieChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    </div>
    <div>
        <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
    </div>

</div>

<script type="text/javascript">
    var numberFormat = d3.format(".2f");

    var ugChart = dc.geoChoroplethChart("#ug-chart");
		var totalsChart = dc.bubbleChart("#totals-chart");
        var nationalPieChart = dc.pieChart("#national-pie-chart")

		var width = 700,
				height = 960;

		var projection = d3.geo.albers()
				.center([33, 0])
				// ug is slanted on albers projection,
				// so adjust pitch and roll
				// such that bottom of ug straight
				// (its straight on mercator projections,
				// which is what most people are used to)
				// [yaw, pitch, roll] AKA [lat, long, roll]
				.rotate([-1, 11.5, -16.4])
				.parallels([25, 35])
				.scale(6000)
				.translate([width / 2, height / 2]);

		// declare some vars here so they are available
		// in the browser console for debugging
		var data;
		var districts;
		var shapes;
        var data1;
        var categories;
        var dominant = "";
		var pollDistricts = [];
		var mapDistricts = [];
        var debug = true;
        var total;

		queue()
			.defer(d3.json, "{{ MEDIA_URL }}ureport/data/districts.json")
			.defer(d3.tsv, "{{ MEDIA_URL }}ureport/data/pulseout.tsv")
            .defer(d3.json, "{{ MEDIA_URL }}ureport/data/category.json")
			.await(ready);

		function ready(error, ug, poll, category) {
				// TODO handle error!
				// TODO maybe rework so that fgmPoll.tsv is organized like this?
				// District Answer Number
				// District1 yes 22
				// District1 no 11
				// i *think* that this sort of structure
				// would make it simpler to group by answer, so you could
				// easily toggle between mapping percentYes to percentNo, etc
				//
				// add poll name to each result record
				// TODO toggle between results from more than one poll
        //data = crossfilter(_.map(poll, function(p) {return _.defaults(p, {'poll': 'fgm'});}));
        shapes = ug;

            data = crossfilter(_.map(category, function(p){return _.defaults(p, {'category': 'irrelevant'})}))
            categories = data.dimension(function(d){
               return d['category']
            });
            districts = data.dimension(function (d) {
                return d["district"];
            });
            caseDistricts = _.unique(_.pluck(districts, 'district'));
            caseTypes = _.unique(_.pluck(categories.top(1000), 'category'));
            categoriesGroup = categories.group().reduceSum(function(d){return d.total});
            categoryColor = d3.scale.ordinal()
                    .domain(caseTypes)
                    .range(["#0000FF", "#000000", "#800080", "#FFA500", "#FF0000", "#808080"]);

				// debug info for comparing districts from map and from poll results
				pollDistricts = _.pluck(poll, 'District');
				mapDistricts = _.map(ug.features, function(d) { return d.properties.name });
				console.log('have results, no map', _.difference(pollDistricts, mapDistricts));
				console.log(_.difference(pollDistricts, mapDistricts).length)
				console.log('on map, not results', _.difference(mapDistricts, pollDistricts));
				console.log(_.difference(mapDistricts, pollDistricts).length)

				// crossfilter dimension for districts


				// crossfilter group (map-reduce) for poll result counts and stats by district
				// see https://github.com/square/crossfilter/wiki/API-Reference#wiki-group_reduce
        var totalAnswersByDistrict = districts.group().reduce(
                function(p, v) {
										// add function
										// reduce by sum
                    p.total += +v.total;
                    if (v.total !== 0){
                        p.categories.push(v.category);
                    }
                    p.counts = _.chain(p.categories).reduce(function(counts, category){
                        counts[category] = (counts[category] || 0) + 1;
                        return counts
                    }, {})
                            .value();

                    p.countList = _.sortBy(_.pairs(p.counts), function(d){return d[1];});
                    total = p;
                    return p;
                },
                function(p, v) {
										// add function
										// reduce by sum
                    p.total -= +v.total;
                    if (v.total !== 0){
                        p.categories.push(v.category);
                    }
                    p.counts = _.chain(p.categories).reduce(function(counts, category){
                        counts[category] = (counts[category] || 0) + 1;
                        return counts
                    }, {})
                            .value();

                    p.countList = _.sortBy(_.pairs(p.counts), function(d){return d[1];});
                    total = p;
                    return p;
                },
                function() {
                    return {total: 0, counts: {}, countsList: [], categories: []};
                }
            );

            maxCategories = _.max(totalAnswersByDistrict.top(1000), function(p) {return p.value.total;}).value.total;
            maxRiskTypes = _.unique(_.max(totalAnswersByDistrict.top(1000), function(p) {return _.unique(p.value.risks).length;}).value.risks).length;

            function enumerateCountsForDatumTitle(d) {
                  var countsText = _.map(d.value.countsList, function(x) {return x[0] + ":\t " + x[1] + "\n";}).join('');
                  return d.key
                          + "\n"
                          + countsText;
            }

				ugChart.width(width)
								.height(height)
								.dimension(districts)
								.projection(projection)
                .group(totalAnswersByDistrict)
								.valueAccessor(function (p) {
										return p.value.total;
								})
								// TODO look into patching dc.js so we can
								// use topojson instead of geojson (topojson files are much smaller)
								.overlayGeoJson(ug.features, "district", function (d) {
                                    if (_.find(caseDistricts, function(x){ return x == d.properties.name; })){
                                      // if district name from map is the same
                                      // as district name in cases, use it
                                      return d.properties.name;
                                    }
                                    // print debug info if district cannont be reconciled with map
                                    if (debug) {
                                      console.log('no district named ', d.properties.name);
                                    }
                                    return d.properties.name;
                                })
								// color across yellow-green-blue range
								// with a domain of 0% yes to 100% yes
								.colors(colorbrewer.YlGnBu[9])
								.colorDomain([0, maxCategories])
								.title(function (d) {
										return "District: " + d.key + "\n Total Messages: " + (d.value ? d.value : 0) + " messages";
								});

            totalsChart.width((width))
                    .height(height/1.5)
                    .margins({top: 10, right: 50, bottom: 30, left: 60})
                    .dimension(districts)
										// FIXME colors shown on chart don't make sense. WTF
										.colors(colorbrewer.YlGnBu[9])
										.colorDomain([0, 100])
                    .group(totalAnswersByDistrict)
                    .keyAccessor(function (p) {
                        return p.value.total;
                    })
                    .valueAccessor(function (p) {
                        return _.unique(p.value.categories).length;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.total;
                    })
										// TODO calculate these domains
                    .x(d3.scale.linear().domain([0, (2 + maxCategories)]))
                    .r(d3.scale.linear().domain([0, maxCategories]))
                    .minRadiusWithLabel(11)
                    .elasticY(true)
                    .yAxisPadding(5)
                    .elasticX(true)
                    .xAxisPadding(200)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return enumerateCountsForDatumTitle(p)
                    });
            totalsChart.yAxis().tickFormat(function (s) {
                return s ;
            });
            totalsChart.xAxis().tickFormat(function (s) {
                return s;
            });

            nationalPieChart
              .width(300)
              .height(200)
              .transitionDuration(500)
              .colors(categoryColor)
              .colorAccessor(function(d, i){return _.indexOf(caseTypes, d.data.key); })
              .radius(90)
              .innerRadius(40)
              .dimension(categories)
              .group(categoriesGroup)
              .renderLabel(true)
              .renderTitle(true);

            dc.renderAll();
    };
</script>
{% endblock %}

